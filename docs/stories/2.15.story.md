# Story 2.15: Fix ESLint React Hooks Violations and Code Quality Issues

## Status

Draft

## Story

**As a** developer,
**I want** all ESLint errors and warnings resolved,
**so that** the codebase follows React best practices, has improved performance, and maintains code quality standards.

## Acceptance Criteria

1. All ESLint errors are resolved (currently 7 errors)
2. Critical ESLint warnings are addressed (React hooks best practices)
3. Code follows React hooks rules for performance and correctness
4. Pre-commit hooks pass without requiring --no-verify
5. No refs accessed during render
6. No setState calls directly in useEffect bodies
7. No impure functions called during render
8. Missing useEffect dependencies are properly handled

## Tasks / Subtasks

- [ ] Task 1: Fix Ref Access During Render (3 errors)
  - [ ] Fix MessageItem.tsx opacityAnim ref access (line 64)
  - [ ] Replace `useRef(...).current` pattern with proper initialization
  - [ ] Consider using useMemo for Animated.Value initialization
  - [ ] Verify animations still work correctly after fix

- [ ] Task 2: Fix setState in useEffect Issues (3 errors)
  - [ ] Fix app/_layout.tsx setIsNavigating call (line 99)
  - [ ] Fix hooks/useOfflineSync.ts setWasOffline call (line 52)
  - [ ] Refactor to use derived state or move logic outside effect
  - [ ] Ensure navigation and sync behavior unchanged

- [ ] Task 3: Fix Impure Function Calls During Render (1 error)
  - [ ] Fix hooks/useGlobalMessageListener.ts Date.now() call (line 26)
  - [ ] Move impure initialization to useEffect or useMemo
  - [ ] Ensure timestamp tracking still works correctly

- [ ] Task 4: Fix Test Hook Reassignment (1 error)
  - [ ] Fix tests/integration/read-receipt-reliability.test.tsx hookResult reassignment (line 697)
  - [ ] Use React Testing Library's renderHook properly
  - [ ] Update test to follow testing best practices

- [ ] Task 5: Address Missing useEffect Dependencies (6+ warnings)
  - [ ] Review all useEffect warnings for missing dependencies
  - [ ] Add missing dependencies where appropriate
  - [ ] Use useCallback for stable function references
  - [ ] Add eslint-disable comments with explanations where intentional
  - [ ] Affected files:
    - app/(tabs)/conversations/[id].tsx (lines 190, 345)
    - app/(tabs)/conversations/group-settings.tsx (line 63)
    - app/(tabs)/conversations/index.tsx (line 146)
    - app/(tabs)/profile/edit.tsx (line 53)
    - app/(tabs)/profile/index.tsx (line 29)

- [ ] Task 6: Clean Up Console.log Statements (15+ warnings)
  - [ ] Replace console.log with console.warn or console.error where appropriate
  - [ ] Remove debug console statements in production code
  - [ ] Consider using a proper logging utility
  - [ ] Affected files:
    - hooks/useNetworkMonitor.ts
    - services/messageService.ts
    - utils/idempotencyHelpers.ts
    - utils/performanceMonitor.ts

- [ ] Task 7: Verify Pre-commit Hooks
  - [ ] Run full lint with all fixes applied
  - [ ] Ensure git commit works without --no-verify
  - [ ] Update husky configuration if needed
  - [ ] Document any remaining intentional warnings

## Dev Notes

### Context
This story was created after commit 26208f7 which implemented Stories 2.9-2.14. The commit required `--no-verify` to bypass pre-commit hooks due to 25 ESLint issues (7 errors, 18 warnings).

### Current ESLint Issues Summary (as of commit 26208f7)

**Errors (7):**
- **react-hooks/refs**: Cannot access refs during render (MessageItem.tsx x3)
- **react-hooks/set-state-in-effect**: setState called synchronously in effects (app/_layout.tsx, useOfflineSync.ts)
- **react-hooks/purity**: Impure function Date.now() called during render (useGlobalMessageListener.ts)
- **react-hooks/globals**: Hook result reassigned in test (read-receipt-reliability.test.tsx)

**Warnings (18):**
- **react-hooks/exhaustive-deps**: Missing dependencies in useEffect arrays (6 files)
- **no-console**: Unexpected console statements in production code (4 files)

### Technical Approach

**Ref Access Fix:**
```typescript
// ❌ Current (wrong)
const opacityAnim = useRef(new Animated.Value(1)).current;

// ✅ Fixed (correct)
const opacityAnimRef = useRef<Animated.Value>();
if (!opacityAnimRef.current) {
  opacityAnimRef.current = new Animated.Value(1);
}
const opacityAnim = opacityAnimRef.current;

// Or use useMemo
const opacityAnim = useMemo(() => new Animated.Value(1), []);
```

**setState in useEffect Fix:**
```typescript
// ❌ Current (wrong)
useEffect(() => {
  // ... some logic
  setState(value); // Synchronous setState
}, [deps]);

// ✅ Fixed (correct) - Option 1: Derived state
const derivedValue = useMemo(() => computeValue(deps), [deps]);

// ✅ Fixed (correct) - Option 2: Move to callback
useEffect(() => {
  const handleAsync = async () => {
    // async work
    setState(value);
  };
  handleAsync();
}, [deps]);
```

### References
- [React Rules of Hooks](https://react.dev/reference/rules)
- [ESLint Plugin React Hooks](https://www.npmjs.com/package/eslint-plugin-react-hooks)
- [React useRef Documentation](https://react.dev/reference/react/useRef)

### Testing Requirements
- All existing tests must continue to pass
- Animation behavior should remain unchanged
- Navigation flow should work identically
- Offline sync functionality must work correctly

### Definition of Done
- [ ] All 7 ESLint errors resolved
- [ ] All critical React hooks warnings addressed
- [ ] Pre-commit hooks pass without --no-verify
- [ ] All tests passing
- [ ] Code review completed
- [ ] Changes committed with proper commit message

## Agent Model Used

<!-- Dev Agent will fill this in during implementation -->

## Dev Agent Record

### Debug Log References
<!-- Dev Agent will add debug entries as needed -->

### Completion Notes
<!-- Dev Agent will fill this in when complete -->

### File List
<!-- Dev Agent will list all modified files here -->

### Change Log
<!-- Dev Agent will document changes made -->
