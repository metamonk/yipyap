# Emergency Hotfix: Critical Features Implementation

**Date:** 2025-01-21
**Priority:** CRITICAL
**Branch:** emergency/critical-features-hotfix

## Context

Emergency implementation of critical features needed immediately for app functionality. These features span multiple planned stories but are being implemented together for urgent business needs.

## Features to Implement

### 1. Online/Offline Status Indicators

**Planned Stories:** 1.6 (Profile), 2.6 (Advanced Chat)
**MVP Implementation:**

- [x] Add presence tracking to Firebase
- [x] Show online/offline indicators in user lists
- [x] Update status on app foreground/background
- [x] Basic "last seen" timestamp

### 2. Basic Group Chat (3+ users)

**Planned Story:** 2.7 (Group Messaging)
**MVP Implementation:**

- [x] Extend conversation model for multiple participants
- [x] Group creation UI (select multiple users)
- [x] Group chat view with member list
- [x] Basic group info display
- [x] Update Firestore rules for group access

### 3. Message Read Receipts

**Planned Story:** 2.1 (Basic Chat)
**MVP Implementation:**

- [x] Add read status to message model
- [x] Track when messages are viewed
- [x] Display read indicators (checkmarks)
- [x] Batch update read status for efficiency

### 4. Push Notifications (Foreground)

**Planned Stories:** 1.1 (Infrastructure), 2.1 (Basic Chat)
**MVP Implementation:**

- [x] Configure Expo Notifications (not FCM)
- [x] Request notification permissions
- [x] Handle foreground notifications
- [x] Display in-app notification banners
- [x] Basic notification for new messages

## Technical Approach

### Data Model Changes

```typescript
// NO CHANGES NEEDED! ðŸŽ‰
// Existing models already support all features:
// - Conversations: type 'group', participantIds[], groupName
// - Messages: readBy[], status field
// - Users: presence.status, presence.lastSeen
```

### Firebase Rules Updates

```javascript
// Minor update to limit group size:
match /conversations/{conversationId} {
  allow create: if request.auth != null &&
    request.auth.uid in request.resource.data.participantIds &&
    request.resource.data.participantIds.size() <= 10; // Add max group size
}
```

### Technical Decisions Log

- **Decision 1: Firestore-only presence**
  - **Rationale:** Simpler than adding Realtime Database, good enough for MVP
  - **Trade-offs:** 30-second update delay vs real-time precision

- **Decision 2: Batch read receipts**
  - **Rationale:** Reduces Firestore writes and costs
  - **Trade-offs:** Slight delay in read status updates

- **Decision 3: Foreground notifications only**
  - **Rationale:** No FCM setup needed, works immediately
  - **Trade-offs:** No notifications when app backgrounded

- **Decision 4: Simple group creation**
  - **Rationale:** Fastest path to working groups
  - **Trade-offs:** No admin controls, no member management

## Technical Debt Created

1. **Presence Update Accuracy**
   - **Impact:** 30-second heartbeat means slight delay in online/offline status
   - **Cleanup Story:** Story 2.6 - Implement Realtime Database for instant presence

2. **Group Management Features**
   - **Impact:** No ability to edit group name, remove members, or leave groups
   - **Cleanup Story:** Story 2.7 - Full group messaging implementation

3. **Read Receipt Batching**
   - **Impact:** Potential for missed read receipts if batch fails
   - **Cleanup Story:** Story 2.1 - Add retry logic and Cloud Functions

4. **Notification Limitations**
   - **Impact:** Only foreground notifications, no background/killed state support
   - **Cleanup Story:** Story 2.1 - Full FCM integration with backend

5. **User List Performance**
   - **Impact:** getAllUsers() fetches entire user base (not paginated)
   - **Cleanup Story:** Story 1.6 - Add user search and pagination

6. **Error Handling**
   - **Impact:** Minimal error recovery in emergency features
   - **Cleanup Story:** Various - Add proper error boundaries and recovery

7. **Test Coverage**
   - **Impact:** Emergency features have no unit/integration tests
   - **Cleanup Story:** QA Epic - Add comprehensive test coverage

## Testing Checklist

- [ ] All features work together without conflicts
- [ ] Firebase rules properly secure group chats
- [ ] Notifications don't spam users
- [ ] Online/offline status updates correctly
- [ ] Read receipts update in real-time
- [ ] Group chat creation and messaging works
- [ ] No regression in existing features

## Rollback Plan

If issues arise:

1. `git checkout main`
2. Revert Firestore rules if deployed
3. Document issues for proper implementation

## Post-Implementation Tasks

1. Update affected story files with hotfix notes
2. Document all technical debt
3. Create cleanup tasks
4. Merge to main when stable
